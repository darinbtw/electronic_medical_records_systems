<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã—Ö –º–µ–¥–∫–∞—Ä—Ç</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
            --text-color: #333;
            --text-muted: #6c757d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1rem 0;
            margin-bottom: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header .subtitle {
            text-align: center;
            opacity: 0.9;
            font-size: 1rem;
        }

        .system-status {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s infinite;
        }

        .status-indicator.error {
            background: var(--danger-color);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: var(--light-bg);
            color: var(--text-color);
        }

        .nav-tab.active {
            background: var(--secondary-color);
            color: white;
            box-shadow: 0 2px 4px rgba(52, 152, 219, 0.3);
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid var(--success-color);
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid var(--danger-color);
        }

        .alert.warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid var(--warning-color);
        }

        .content-section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .grid {
            display: grid;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            white-space: nowrap;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2980b9;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .btn-outline:hover {
            background: var(--light-bg);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--secondary-color), #5dade2);
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card.warning {
            background: linear-gradient(135deg, var(--warning-color), #f7dc6f);
        }

        .stat-card.success {
            background: linear-gradient(135deg, var(--success-color), #58d68d);
        }

        .stat-card.danger {
            background: linear-gradient(135deg, var(--danger-color), #ec7063);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .table th {
            background: var(--light-bg);
            font-weight: 600;
            color: var(--primary-color);
        }

        .table tbody tr:hover {
            background: #f8f9fa;
        }

        .table tbody tr.clickable {
            cursor: pointer;
        }

        .table tbody tr.clickable:hover {
            background: #e3f2fd;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .loading::before {
            content: '';
            display: inline-block;
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-color);
            border-top-color: var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 4px;
            margin: 1rem 0;
        }

        .pagination .btn {
            min-width: 40px;
            height: 40px;
            padding: 8px;
        }

        .pagination .btn.active {
            background: var(--secondary-color);
            color: white;
        }

        .pagination-info {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .btn-group {
                justify-content: center;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üè• –°–∏—Å—Ç–µ–º–∞ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã—Ö –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∫–∞—Ä—Ç</h1>
            <p class="subtitle">–°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ —Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º</p>
            
            <div class="system-status">
                <div class="status-item">
                    <div class="status-indicator" id="db-status"></div>
                    <span>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</span>
                </div>
                <div class="status-item">
                    <div class="status-indicator" id="api-status"></div>
                    <span>API —Å–µ—Ä–≤–µ—Ä</span>
                </div>
                <div class="status-item">
                    <div class="status-indicator" id="tde-status"></div>
                    <span>TDE —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ</span>
                </div>
            </div>
        </header>

        <!-- Alert Messages -->
        <div id="alert-container">
            <div id="alert-message" class="alert"></div>
        </div>

        <!-- Navigation Tabs -->
        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('dashboard')">üìä –ì–ª–∞–≤–Ω–∞—è</button>
            <button class="nav-tab" onclick="showSection('patients')">üë• –ü–∞—Ü–∏–µ–Ω—Ç—ã</button>
            <button class="nav-tab" onclick="showSection('appointments')">üìÖ –ü—Ä–∏—ë–º—ã</button>
            <button class="nav-tab" onclick="showSection('records')">üìã –ú–µ–¥–∫–∞—Ä—Ç—ã</button>
            <button class="nav-tab" onclick="showSection('doctors')">üë®‚Äç‚öïÔ∏è –í—Ä–∞—á–∏</button>
            <button class="nav-tab" onclick="showSection('statistics')">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        </nav>

        <!-- Dashboard Section -->
        <section id="dashboard" class="content-section active">
            <div class="stats-grid" id="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-number" id="stat-patients">0</div>
                    <div class="stat-label">–ü–∞—Ü–∏–µ–Ω—Ç–æ–≤</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-number" id="stat-doctors">0</div>
                    <div class="stat-label">–í—Ä–∞—á–µ–π</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-number" id="stat-appointments">0</div>
                    <div class="stat-label">–ü—Ä–∏—ë–º–æ–≤</div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-number" id="stat-scheduled">0</div>
                    <div class="stat-label">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</div>
                </div>
            </div>

            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üîç –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫</h3>
                    </div>
                    
                    <form id="quick-search-form">
                        <div class="form-group">
                            <label class="form-label">–ü–æ–∏—Å–∫ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –ø–æ –§–ò–û</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="quick-search-input"
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è, —Ñ–∞–º–∏–ª–∏—é –∏–ª–∏ –æ—Ç—á–µ—Å—Ç–≤–æ..."
                                   minlength="2">
                        </div>
                        
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">
                                üîç –ù–∞–π—Ç–∏
                            </button>
                            <button type="button" class="btn btn-outline" onclick="clearQuickSearch()">
                                ‚úñÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
                            </button>
                        </div>
                    </form>

                    <div id="quick-search-results" style="margin-top: 1rem;"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ</h3>
                    </div>
                    
                    <div class="system-info">
                        <p><strong>–í–µ—Ä—Å–∏—è:</strong> 12.10.5</p>
                        <p><strong>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:</strong> PostgreSQL —Å —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–µ–π</p>
                        <p><strong>–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ:</strong> AES-256-CBC (TDE)</p>
                        <p><strong>Backup:</strong> –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π</p>
                        <p><strong>API:</strong> <a href="/api" target="_blank">–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</a></p>
                    </div>

                    <div class="btn-group" style="margin-top: 1rem;">
                        <button class="btn btn-outline btn-sm" onclick="checkSystemHealth()">
                            üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
                        </button>
                        <button class="btn btn-outline btn-sm" onclick="loadDashboardData()">
                            üìä –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Patients Section -->
        <section id="patients" class="content-section">
            <div class="grid grid-2">
                <!-- Add Patient Form -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞</h3>
                    </div>
                    
                    <form id="patient-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">–§–∞–º–∏–ª–∏—è *</label>
                                <input type="text" name="last_name" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">–ò–º—è *</label>
                                <input type="text" name="first_name" class="form-control" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">–û—Ç—á–µ—Å—Ç–≤–æ</label>
                                <input type="text" name="middle_name" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è *</label>
                                <input type="date" name="birth_date" class="form-control" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">–ü–æ–ª *</label>
                                <select name="gender" class="form-control" required>
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª</option>
                                    <option value="M">–ú—É–∂—Å–∫–æ–π</option>
                                    <option value="F">–ñ–µ–Ω—Å–∫–∏–π</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                <input type="tel" name="phone" class="form-control" placeholder="+7 (999) 123-45-67">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-control">
                        </div>

                        <div class="form-group">
                            <label class="form-label">–ê–¥—Ä–µ—Å</label>
                            <textarea name="address" class="form-control" rows="2" 
                                      placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞"></textarea>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn btn-success">
                                ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞
                            </button>
                            <button type="reset" class="btn btn-outline">
                                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Search Patients -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üîç –ü–æ–∏—Å–∫ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤</h3>
                    </div>
                    
                    <form id="patient-search-form">
                        <div class="form-group">
                            <label class="form-label">–ü–æ–∏—Å–∫ –ø–æ –§–ò–û –∏–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="patient-search-input"
                                   placeholder="–§–∞–º–∏–ª–∏—è, –∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ email..."
                                   minlength="2">
                        </div>
                        
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">
                                üîç –ù–∞–π—Ç–∏
                            </button>
                            <button type="button" class="btn btn-outline" onclick="loadPatients()">
                                üìã –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö
                            </button>
                            <button type="button" class="btn btn-outline" onclick="clearPatientSearch()">
                                ‚úñÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Patients List -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üë• –°–ø–∏—Å–æ–∫ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤</h3>
                    <div class="btn-group">
                        <button class="btn btn-outline btn-sm" onclick="loadPatients(1, 20)">
                            20 –Ω–∞ —Å—Ç—Ä.
                        </button>
                        <button class="btn btn-outline btn-sm" onclick="loadPatients(1, 50)">
                            50 –Ω–∞ —Å—Ç—Ä.
                        </button>
                    </div>
                </div>
                
                <div id="patients-list-container">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤...</div>
                </div>
            </div>
        </section>

        <!-- Appointments Section -->
        <section id="appointments" class="content-section">
            <div class="grid grid-2">
                <!-- Create Appointment Form -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">‚ûï –ó–∞–ø–∏—Å–∞—Ç—å –Ω–∞ –ø—Ä–∏—ë–º</h3>
                    </div>
                    
                    <form id="appointment-form">
                        <div class="form-group">
                            <label class="form-label">–ü–∞—Ü–∏–µ–Ω—Ç *</label>
                            <select name="patient_id" class="form-control" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">–í—Ä–∞—á *</label>
                            <select name="doctor_id" class="form-control" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">–î–∞—Ç–∞ –ø—Ä–∏—ë–º–∞ *</label>
                                <input type="date" name="appointment_date" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">–í—Ä–µ–º—è *</label>
                                <input type="time" name="appointment_time" class="form-control" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                            <select name="status" class="form-control">
                                <option value="scheduled">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω</option>
                                <option value="completed">–ó–∞–≤–µ—Ä—à—ë–Ω</option>
                                <option value="cancelled">–û—Ç–º–µ–Ω—ë–Ω</option>
                            </select>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn btn-success">
                                ‚úÖ –ó–∞–ø–∏—Å–∞—Ç—å –Ω–∞ –ø—Ä–∏—ë–º
                            </button>
                            <button type="reset" class="btn btn-outline">
                                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Filter Appointments -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üîç –§–∏–ª—å—Ç—Ä –ø—Ä–∏—ë–º–æ–≤</h3>
                    </div>
                    
                    <form id="appointment-filter-form">
                        <div class="form-group">
                            <label class="form-label">–°—Ç–∞—Ç—É—Å –ø—Ä–∏—ë–º–∞</label>
                            <select class="form-control" id="appointment-status-filter">
                                <option value="">–í—Å–µ –ø—Ä–∏—ë–º—ã</option>
                                <option value="scheduled">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
                                <option value="completed">–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ</option>
                                <option value="cancelled">–û—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ</option>
                            </select>
                        </div>
                        
                        <div class="btn-group">
                            <button type="button" class="btn btn-primary" onclick="filterAppointments()">
                                üîç –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä
                            </button>
                            <button type="button" class="btn btn-outline" onclick="loadAppointments()">
                                üìã –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Appointments List -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìÖ –°–ø–∏—Å–æ–∫ –ø—Ä–∏—ë–º–æ–≤</h3>
                    <div class="btn-group">
                        <button class="btn btn-outline btn-sm" onclick="loadAppointments(1, 20)">
                            20 –Ω–∞ —Å—Ç—Ä.
                        </button>
                        <button class="btn btn-outline btn-sm" onclick="loadAppointments(1, 50)">
                            50 –Ω–∞ —Å—Ç—Ä.
                        </button>
                    </div>
                </div>
                
                <div id="appointments-list-container">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏—ë–º–æ–≤...</div>
                </div>
            </div>
        </section>

        <!-- Medical Records Section -->
        <section id="records" class="content-section">
            <div class="grid grid-2">
                <!-- Create Medical Record Form -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">‚ûï –°–æ–∑–¥–∞—Ç—å –º–µ–¥–∫–∞—Ä—Ç—É</h3>
                    </div>
                    
                    <form id="medical-record-form">
                        <div class="form-group">
                            <label class="form-label">–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π –ø—Ä–∏—ë–º *</label>
                            <select name="appointment_id" class="form-control" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—ë–º</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">–ñ–∞–ª–æ–±—ã –ø–∞—Ü–∏–µ–Ω—Ç–∞</label>
                            <textarea name="complaints" class="form-control" rows="3" 
                                      placeholder="–û—Å–Ω–æ–≤–Ω—ã–µ –∂–∞–ª–æ–±—ã –ø–∞—Ü–∏–µ–Ω—Ç–∞..."></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Å–º–æ—Ç—Ä–∞</label>
                            <textarea name="examination_results" class="form-control" rows="3" 
                                      placeholder="–î–∞–Ω–Ω—ã–µ –æ—Å–º–æ—Ç—Ä–∞, –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏..."></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">–î–∏–∞–≥–Ω–æ–∑ * (–±—É–¥–µ—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω)</label>
                            <textarea name="diagnosis" class="form-control" rows="2" required
                                      placeholder="–î–∏–∞–≥–Ω–æ–∑ –≤—Ä–∞—á–∞..."></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">–ù–∞–∑–Ω–∞—á–µ–Ω–∏—è</label>
                            <div id="prescriptions-container">
                                <div class="prescription-item" style="border: 1px solid var(--border-color); padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <input type="text" name="medication_name_1" class="form-control" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞">
                                        </div>
                                        <div class="form-group">
                                            <input type="text" name="dosage_1" class="form-control" placeholder="–î–æ–∑–∏—Ä–æ–≤–∫–∞">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <input type="text" name="frequency_1" class="form-control" placeholder="–ß–∞—Å—Ç–æ—Ç–∞ –ø—Ä–∏—ë–º–∞">
                                        </div>
                                        <div class="form-group">
                                            <input type="text" name="duration_1" class="form-control" placeholder="–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <input type="text" name="notes_1" class="form-control" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏—è">
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline btn-sm" onclick="addPrescription()">
                                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ
                            </button>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn btn-success">
                                ‚úÖ –°–æ–∑–¥–∞—Ç—å –º–µ–¥–∫–∞—Ä—Ç—É
                            </button>
                            <button type="reset" class="btn btn-outline">
                                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Medical Records Search -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üîç –ü–æ–∏—Å–∫ –º–µ–¥–∫–∞—Ä—Ç</h3>
                    </div>
                    
                    <form id="records-search-form">
                        <div class="form-group">
                            <label class="form-label">–ü–æ–∏—Å–∫ –ø–æ –ø–∞—Ü–∏–µ–Ω—Ç—É</label>
                            <input type="text" class="form-control" id="records-search-input"
                                   placeholder="–§–ò–û –ø–∞—Ü–∏–µ–Ω—Ç–∞...">
                        </div>
                        
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">
                                üîç –ù–∞–π—Ç–∏
                            </button>
                            <button type="button" class="btn btn-outline" onclick="loadMedicalRecords()">
                                üìã –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Medical Records List -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìã –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –∑–∞–ø–∏—Å–∏</h3>
                    <div class="btn-group">
                        <button class="btn btn-outline btn-sm" onclick="loadMedicalRecords(1, 20)">
                            20 –Ω–∞ —Å—Ç—Ä.
                        </button>
                        <button class="btn btn-outline btn-sm" onclick="loadMedicalRecords(1, 50)">
                            50 –Ω–∞ —Å—Ç—Ä.
                        </button>
                    </div>
                </div>
                
                <div id="medical-records-list-container">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∫–∞—Ä—Ç...</div>
                </div>
            </div>
        </section>

        <section id="doctors" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üë®‚Äç‚öïÔ∏è –í—Ä–∞—á–∏</h3>
                </div>
                <div id="doctors-list-container">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≤—Ä–∞—á–µ–π...</div>
                </div>
            </div>
        </section>

        <section id="statistics" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                </div>
                <div id="statistics-container">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Global Configuration
        const API_BASE_URL = window.location.origin;
        
        // Global State
        let currentSection = 'dashboard';
        let currentPage = { patients: 1, appointments: 1, records: 1 };

        // Utility Functions
        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ru-RU');
            } catch (e) {
                return dateString;
            }
        }

        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return '-';
            try {
                const date = new Date(dateTimeString);
                return date.toLocaleString('ru-RU');
            } catch (e) {
                return dateTimeString;
            }
        }

        function formatPhone(phone) {
            return phone || '–Ω–µ —É–∫–∞–∑–∞–Ω';
        }

        function formatEmail(email) {
            return email || '–Ω–µ —É–∫–∞–∑–∞–Ω';
        }

        // Alert System
        function showAlert(message, type = 'success') {
            const alertEl = document.getElementById('alert-message');
            alertEl.className = `alert ${type}`;
            alertEl.textContent = message;
            alertEl.style.display = 'flex';
            
            setTimeout(() => {
                alertEl.style.display = 'none';
            }, 5000);
        }

        // API Client with better error handling
        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                },
            };

            try {
                console.log('API Request:', url, options); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
                
                const response = await fetch(url, { ...defaultOptions, ...options });
                
                if (!response.ok) {
                    let errorMessage;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorData.message || `HTTP ${response.status}`;
                        console.log('–û—à–∏–±–∫–∞ API (JSON):', errorData); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    } catch (e) {
                        const errorText = await response.text();
                        errorMessage = errorText || `HTTP ${response.status}: ${response.statusText}`;
                        console.log('–û—à–∏–±–∫–∞ API (Text):', errorText); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    }
                    throw new Error(errorMessage);
                }

                const responseData = await response.json();
                console.log('API Response:', responseData); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
                return responseData;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Navigation
        function showSection(sectionId) {
            // Update tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[onclick="showSection('${sectionId}')"]`).classList.add('active');

            // Update sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            currentSection = sectionId;

            // Load section data
            loadSectionData(sectionId);
        }

        function loadSectionData(sectionId) {
            switch (sectionId) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'patients':
                    loadPatients();
                    break;
                case 'doctors':
                    loadDoctors();
                    break;
                case 'statistics':
                    loadStatistics();
                    break;
            }
        }

        // Dashboard
        async function loadDashboard() {
            try {
                const stats = await apiRequest('/api/statistics');
                
                // Update dashboard stats
                document.getElementById('stat-patients').textContent = stats.general?.total_patients || 0;
                document.getElementById('stat-doctors').textContent = stats.general?.total_doctors || 0;
                document.getElementById('stat-appointments').textContent = stats.general?.total_appointments || 0;
                document.getElementById('stat-scheduled').textContent = stats.general?.scheduled_appointments || 0;
                
            } catch (error) {
                console.error('Dashboard load error:', error);
                showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + error.message, 'error');
            }
        }

        // Patients
        async function loadPatients(page = 1, perPage = 20) {
            const container = document.getElementById('patients-list-container');
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤...</div>';

            try {
                const response = await apiRequest(`/api/patients?page=${page}&per_page=${perPage}`);
                renderPatientsList(response, container);
                currentPage.patients = page;
            } catch (error) {
                container.innerHTML = `<div class="alert error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }

        function renderPatientsList(response, container) {
            if (!response.patients || response.patients.length === 0) {
                container.innerHTML = '<div class="empty-state">–ü–∞—Ü–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            let html = `
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–§–ò–û</th>
                                <th>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</th>
                                <th>–ü–æ–ª</th>
                                <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                <th>Email</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            response.patients.forEach(patient => {
                const fullName = `${patient.last_name} ${patient.first_name} ${patient.middle_name || ''}`.trim();
                const gender = patient.gender === 'M' ? 'üë® –ú' : 'üë© –ñ';
                
                html += `
                    <tr class="clickable" onclick="viewPatientDetails(${patient.id})">
                        <td>${patient.id}</td>
                        <td><strong>${fullName}</strong></td>
                        <td>${formatDate(patient.birth_date)}</td>
                        <td>${gender}</td>
                        <td>${formatPhone(patient.phone)}</td>
                        <td>${formatEmail(patient.email)}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            // Add pagination if needed
            if (response.pagination && response.pagination.pages > 1) {
                html += renderPagination(response.pagination, 'loadPatients');
            }

            container.innerHTML = html;
        }

        function renderPagination(pagination, functionName) {
            const { page, pages } = pagination;
            
            let html = '<div class="pagination">';
            
            // Previous button
            html += `<button class="btn btn-outline ${page <= 1 ? '' : 'btn-primary'}" 
                     ${page <= 1 ? 'disabled' : ''} 
                     onclick="${functionName}(${page - 1})">‚Äπ</button>`;
            
            // Page numbers
            const startPage = Math.max(1, page - 2);
            const endPage = Math.min(pages, page + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="btn ${i === page ? 'btn-primary active' : 'btn-outline'}" 
                         onclick="${functionName}(${i})">${i}</button>`;
            }
            
            // Next button
            html += `<button class="btn btn-outline ${page >= pages ? '' : 'btn-primary'}" 
                     ${page >= pages ? 'disabled' : ''} 
                     onclick="${functionName}(${page + 1})">‚Ä∫</button>`;
            
            html += '</div>';
            html += `<div class="pagination-info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${page} –∏–∑ ${pages}</div>`;
            
            return html;
        }

        // Search patients
        async function searchPatients(event) {
            event.preventDefault();
            const query = document.getElementById('patient-search-input').value.trim();
            
            if (query.length < 2) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞', 'warning');
                return;
            }

            const container = document.getElementById('patients-list-container');
            container.innerHTML = '<div class="loading">–ü–æ–∏—Å–∫ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤...</div>';

            try {
                const response = await apiRequest(`/api/search?q=${encodeURIComponent(query)}`);
                
                if (response.patients && response.patients.length > 0) {
                    renderSearchResults(response.patients, container);
                } else {
                    container.innerHTML = '<div class="empty-state">–ü–æ –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="alert error">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ${error.message}</div>`;
            }
        }

        function renderSearchResults(patients, container) {
            let html = `
                <div style="padding: 1rem; background: #e3f2fd; border-radius: 8px; margin-bottom: 1rem;">
                    üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞: –Ω–∞–π–¥–µ–Ω–æ ${patients.length} –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–§–ò–û</th>
                                <th>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</th>
                                <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                <th>Email</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            patients.forEach(patient => {
                const fullName = `${patient.last_name} ${patient.first_name} ${patient.middle_name || ''}`.trim();
                html += `
                    <tr class="clickable" onclick="viewPatientDetails(${patient.id})">
                        <td>${patient.id}</td>
                        <td><strong>${fullName}</strong></td>
                        <td>${formatDate(patient.birth_date)}</td>
                        <td>${formatPhone(patient.phone)}</td>
                        <td>${formatEmail(patient.email)}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        // Patient details
        async function viewPatientDetails(patientId) {
            try {
                const patient = await apiRequest(`/api/patients/${patientId}`);
                
                const details = `
–ü–∞—Ü–∏–µ–Ω—Ç: ${patient.last_name} ${patient.first_name} ${patient.middle_name || ''}
–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: ${formatDate(patient.birth_date)}
–ü–æ–ª: ${patient.gender === 'M' ? '–ú—É–∂—Å–∫–æ–π' : '–ñ–µ–Ω—Å–∫–∏–π'}
–¢–µ–ª–µ—Ñ–æ–Ω: ${formatPhone(patient.phone)}
Email: ${formatEmail(patient.email)}
–ê–¥—Ä–µ—Å: ${patient.address || '–Ω–µ —É–∫–∞–∑–∞–Ω'}

–í—Å–µ–≥–æ –ø—Ä–∏—ë–º–æ–≤: ${patient.total_appointments || 0}
–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏—ë–º: ${formatDateTime(patient.last_appointment)}
                `.trim();

                alert(details);
            } catch (error) {
                showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–∞—Ü–∏–µ–Ω—Ç–∞: ' + error.message, 'error');
            }
        }

        // Create patient
        async function createPatient(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);

            // Validate required fields
            const requiredFields = ['first_name', 'last_name', 'birth_date', 'gender'];
            for (let field of requiredFields) {
                if (!data[field] || data[field].trim() === '') {
                    showAlert(`–ü–æ–ª–µ "${field}" –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è`, 'error');
                    return;
                }
            }

            // Clean and validate phone
            if (data.phone) {
                let phone = data.phone.replace(/\D/g, ''); // Remove all non-digits
                if (phone.length === 11 && phone.startsWith('7')) {
                    data.phone = `+${phone}`;
                } else if (phone.length === 11 && phone.startsWith('8')) {
                    data.phone = `+7${phone.slice(1)}`;
                } else if (phone.length === 10) {
                    data.phone = `+7${phone}`;
                } else if (phone.length < 10 || phone.length > 11) {
                    showAlert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –í–≤–µ–¥–∏—Ç–µ —Ä–æ—Å—Å–∏–π—Å–∫–∏–π –Ω–æ–º–µ—Ä', 'error');
                    return;
                }
            } else {
                // Remove empty phone field
                delete data.phone;
            }

            // Clean empty fields
            Object.keys(data).forEach(key => {
                if (data[key] === '' || data[key] === null) {
                    delete data[key];
                }
            });

            console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:', data); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏

            try {
                const response = await apiRequest('/api/patients', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                showAlert('–ü–∞—Ü–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω');
                event.target.reset();
                
                if (currentSection === 'patients') {
                    loadPatients();
                }
            } catch (error) {
                console.error('–ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞:', error); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
                showAlert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞: ' + error.message, 'error');
            }
        }

        // Quick search
        async function quickSearch(event) {
            event.preventDefault();
            const query = document.getElementById('quick-search-input').value.trim();
            
            if (query.length < 2) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞', 'warning');
                return;
            }

            const resultsContainer = document.getElementById('quick-search-results');
            resultsContainer.innerHTML = '<div class="loading">–ü–æ–∏—Å–∫...</div>';

            try {
                const response = await apiRequest(`/api/search?q=${encodeURIComponent(query)}`);
                renderQuickSearchResults(response.patients || [], resultsContainer);
            } catch (error) {
                resultsContainer.innerHTML = `<div class="alert error">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ${error.message}</div>`;
            }
        }

        function renderQuickSearchResults(patients, container) {
            if (patients.length === 0) {
                container.innerHTML = '<div class="empty-state">–ü–∞—Ü–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            let html = `<h4 style="margin: 1rem 0 0.5rem 0; color: var(--primary-color);">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ (${patients.length})</h4>`;
            
            patients.forEach(patient => {
                const fullName = `${patient.last_name} ${patient.first_name} ${patient.middle_name || ''}`.trim();
                html += `
                    <div onclick="viewPatientDetails(${patient.id})" style="cursor: pointer; padding: 12px; margin: 8px 0; background: #f8f9fa; border-radius: 6px; border-left: 4px solid var(--secondary-color);">
                        <strong>${fullName}</strong><br>
                        <small>
                            –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: ${formatDate(patient.birth_date)} | 
                            –¢–µ–ª–µ—Ñ–æ–Ω: ${formatPhone(patient.phone)} | 
                            Email: ${formatEmail(patient.email)}
                        </small>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Load doctors
        async function loadDoctors() {
            const container = document.getElementById('doctors-list-container');
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Ä–∞—á–µ–π...</div>';

            try {
                const response = await apiRequest('/api/search?type=doctors');
                renderDoctorsList(response.doctors || [], container);
            } catch (error) {
                container.innerHTML = `<div class="alert error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }

        function renderDoctorsList(doctors, container) {
            if (doctors.length === 0) {
                container.innerHTML = '<div class="empty-state">–í—Ä–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            let html = `
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–§–ò–û</th>
                                <th>–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</th>
                                <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                <th>Email</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            doctors.forEach(doctor => {
                const fullName = `${doctor.last_name} ${doctor.first_name} ${doctor.middle_name || ''}`.trim();
                html += `
                    <tr>
                        <td>${doctor.id}</td>
                        <td><strong>${fullName}</strong></td>
                        <td><span class="badge badge-success">${doctor.specialization}</span></td>
                        <td>${formatPhone(doctor.phone)}</td>
                        <td>${formatEmail(doctor.email)}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        // Load statistics
        async function loadStatistics() {
            const container = document.getElementById('statistics-container');
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</div>';

            try {
                const stats = await apiRequest('/api/statistics');
                renderStatistics(stats, container);
            } catch (error) {
                container.innerHTML = `<div class="alert error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ${error.message}</div>`;
            }
        }

        function renderStatistics(stats, container) {
            if (!stats.general) {
                container.innerHTML = '<div class="empty-state">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</div>';
                return;
            }

            let html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${stats.general.total_patients || 0}</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-number">${stats.general.total_doctors || 0}</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –≤—Ä–∞—á–µ–π</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-number">${stats.general.total_appointments || 0}</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –ø—Ä–∏—ë–º–æ–≤</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-number">${stats.general.scheduled_appointments || 0}</div>
                        <div class="stat-label">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</div>
                    </div>
                </div>
            `;

            if (stats.doctors && stats.doctors.length > 0) {
                html += `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Ä–∞—á–∞–º</h3>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>–í—Ä–∞—á</th>
                                        <th>–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</th>
                                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏—ë–º–æ–≤</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                stats.doctors.forEach(doctor => {
                    html += `
                        <tr>
                            <td><strong>${doctor.last_name} ${doctor.first_name}</strong></td>
                            <td>${doctor.specialization}</td>
                            <td><span class="badge badge-success">${doctor.appointment_count}</span></td>
                        </tr>
                    `;
                });

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // System health check
        async function checkSystemHealth() {
            showAlert('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏—Å—Ç–µ–º—ã...', 'warning');
            
            try {
                const health = await apiRequest('/health');
                
                // Update indicators
                const dbStatus = document.getElementById('db-status');
                const apiStatus = document.getElementById('api-status');
                const tdeStatus = document.getElementById('tde-status');
                
                dbStatus.className = `status-indicator ${health.database === 'OK' ? '' : 'error'}`;
                apiStatus.className = `status-indicator ${health.status === 'OK' ? '' : 'error'}`;
                tdeStatus.className = `status-indicator ${health.details && !health.details.error ? '' : 'error'}`;
                
                const healthyCount = [
                    health.database === 'OK',
                    health.status === 'OK',
                    health.details && !health.details.error
                ].filter(Boolean).length;
                
                showAlert(`–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ${healthyCount}/3 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ`);
                
            } catch (error) {
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞: ' + error.message, 'error');
                
                // Mark all as error
                document.querySelectorAll('.status-indicator').forEach(indicator => {
                    indicator.classList.add('error');
                });
            }
        }

        // Helper functions
        function clearQuickSearch() {
            document.getElementById('quick-search-input').value = '';
            document.getElementById('quick-search-results').innerHTML = '';
        }

        function clearPatientSearch() {
            document.getElementById('patient-search-input').value = '';
            loadPatients();
        }

        function loadDashboardData() {
            loadDashboard();
            showAlert('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
        }

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üè• –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –º–µ–¥–∫–∞—Ä—Ç...');
            
            // Setup forms
            document.getElementById('quick-search-form').addEventListener('submit', quickSearch);
            document.getElementById('patient-form').addEventListener('submit', createPatient);
            document.getElementById('patient-search-form').addEventListener('submit', searchPatients);

            // Setup date inputs
            const today = new Date().toISOString().split('T')[0];
            const birthDateInput = document.querySelector('input[name="birth_date"]');
            if (birthDateInput) {
                birthDateInput.max = today;
            }

            // Enhanced auto-format phone inputs
            document.querySelectorAll('input[type="tel"]').forEach(input => {
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    
                    // Don't format if empty
                    if (value === '') {
                        e.target.value = '';
                        return;
                    }
                    
                    // Convert 8 to 7
                    if (value.startsWith('8') && value.length === 11) {
                        value = '7' + value.slice(1);
                    }
                    
                    // Format based on length
                    if (value.length <= 1) {
                        e.target.value = value.startsWith('7') ? '+7' : value;
                    } else if (value.length <= 4) {
                        e.target.value = `+7 (${value.slice(1)}`;
                    } else if (value.length <= 7) {
                        e.target.value = `+7 (${value.slice(1,4)}) ${value.slice(4)}`;
                    } else if (value.length <= 9) {
                        e.target.value = `+7 (${value.slice(1,4)}) ${value.slice(4,7)}-${value.slice(7)}`;
                    } else if (value.length <= 11) {
                        e.target.value = `+7 (${value.slice(1,4)}) ${value.slice(4,7)}-${value.slice(7,9)}-${value.slice(9,11)}`;
                    }
                });

                // Add placeholder and pattern
                input.placeholder = '+7 (999) 123-45-67';
                input.pattern = '\\+7\\s\\([0-9]{3}\\)\\s[0-9]{3}-[0-9]{2}-[0-9]{2}';
            });

            // Add form validation helper
            function validateForm(form) {
                let isValid = true;
                const inputs = form.querySelectorAll('[required]');
                
                inputs.forEach(input => {
                    if (!input.value.trim()) {
                        input.style.borderColor = 'var(--danger-color)';
                        isValid = false;
                    } else {
                        input.style.borderColor = '';
                    }
                });
                
                return isValid;
            }

            // Add real-time validation to required fields
            document.querySelectorAll('[required]').forEach(input => {
                input.addEventListener('blur', function() {
                    if (!this.value.trim()) {
                        this.style.borderColor = 'var(--danger-color)';
                    } else {
                        this.style.borderColor = '';
                    }
                });
                
                input.addEventListener('input', function() {
                    if (this.value.trim()) {
                        this.style.borderColor = '';
                    }
                });
            });

            // Initial load
            checkSystemHealth();
            loadDashboard();
            
            console.log('‚úÖ –°–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
        });

        // Error handling
        window.addEventListener('error', function(e) {
            console.error('–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞:', e.error);
            showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.', 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ Promise:', e.reason);
            if (e.reason && e.reason.message) {
                showAlert('–û—à–∏–±–∫–∞ API: ' + e.reason.message, 'error');
            }
        });

        console.log('üè• –°–∏—Å—Ç–µ–º–∞ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã—Ö –º–µ–¥–∫–∞—Ä—Ç –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!');
    </script>
</body>
</html>