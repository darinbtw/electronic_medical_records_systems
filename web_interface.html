<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Система электронных медкарт</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
            --text-color: #333;
            --text-muted: #6c757d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1rem 0;
            margin-bottom: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header .subtitle {
            text-align: center;
            opacity: 0.9;
            font-size: 1rem;
        }

        .system-status {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s infinite;
        }

        .status-indicator.error {
            background: var(--danger-color);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: var(--light-bg);
            color: var(--text-color);
        }

        .nav-tab.active {
            background: var(--secondary-color);
            color: white;
            box-shadow: 0 2px 4px rgba(52, 152, 219, 0.3);
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid var(--success-color);
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid var(--danger-color);
        }

        .alert.warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid var(--warning-color);
        }

        .content-section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .grid {
            display: grid;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            white-space: nowrap;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2980b9;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .btn-outline:hover {
            background: var(--light-bg);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--secondary-color), #5dade2);
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card.warning {
            background: linear-gradient(135deg, var(--warning-color), #f7dc6f);
        }

        .stat-card.success {
            background: linear-gradient(135deg, var(--success-color), #58d68d);
        }

        .stat-card.danger {
            background: linear-gradient(135deg, var(--danger-color), #ec7063);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .table th {
            background: var(--light-bg);
            font-weight: 600;
            color: var(--primary-color);
        }

        .table tbody tr:hover {
            background: #f8f9fa;
        }

        .table tbody tr.clickable {
            cursor: pointer;
        }

        .table tbody tr.clickable:hover {
            background: #e3f2fd;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .loading::before {
            content: '';
            display: inline-block;
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-color);
            border-top-color: var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 4px;
            margin: 1rem 0;
        }

        .pagination .btn {
            min-width: 40px;
            height: 40px;
            padding: 8px;
        }

        .pagination .btn.active {
            background: var(--secondary-color);
            color: white;
        }

        .pagination-info {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .btn-group {
                justify-content: center;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>🏥 Система электронных медицинских карт</h1>
            <p class="subtitle">Современное управление медицинскими данными с шифрованием</p>
            
            <div class="system-status">
                <div class="status-item">
                    <div class="status-indicator" id="db-status"></div>
                    <span>База данных</span>
                </div>
                <div class="status-item">
                    <div class="status-indicator" id="api-status"></div>
                    <span>API сервер</span>
                </div>
                <div class="status-item">
                    <div class="status-indicator" id="tde-status"></div>
                    <span>TDE шифрование</span>
                </div>
            </div>
        </header>

        <!-- Alert Messages -->
        <div id="alert-container">
            <div id="alert-message" class="alert"></div>
        </div>

        <!-- Navigation Tabs -->
        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('dashboard')">📊 Главная</button>
            <button class="nav-tab" onclick="showSection('patients')">👥 Пациенты</button>
            <button class="nav-tab" onclick="showSection('appointments')">📅 Приёмы</button>
            <button class="nav-tab" onclick="showSection('records')">📋 Медкарты</button>
            <button class="nav-tab" onclick="showSection('doctors')">👨‍⚕️ Врачи</button>
            <button class="nav-tab" onclick="showSection('statistics')">📈 Статистика</button>
        </nav>

        <!-- Dashboard Section -->
        <section id="dashboard" class="content-section active">
            <div class="stats-grid" id="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-number" id="stat-patients">0</div>
                    <div class="stat-label">Пациентов</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-number" id="stat-doctors">0</div>
                    <div class="stat-label">Врачей</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-number" id="stat-appointments">0</div>
                    <div class="stat-label">Приёмов</div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-number" id="stat-scheduled">0</div>
                    <div class="stat-label">Запланировано</div>
                </div>
            </div>

            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">🔍 Быстрый поиск</h3>
                    </div>
                    
                    <form id="quick-search-form">
                        <div class="form-group">
                            <label class="form-label">Поиск пациента по ФИО</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="quick-search-input"
                                   placeholder="Введите имя, фамилию или отчество..."
                                   minlength="2">
                        </div>
                        
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">
                                🔍 Найти
                            </button>
                            <button type="button" class="btn btn-outline" onclick="clearQuickSearch()">
                                ✖️ Очистить
                            </button>
                        </div>
                    </form>

                    <div id="quick-search-results" style="margin-top: 1rem;"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ℹ️ Информация о системе</h3>
                    </div>
                    
                    <div class="system-info">
                        <p><strong>Версия:</strong> 12.10.5</p>
                        <p><strong>База данных:</strong> PostgreSQL с репликацией</p>
                        <p><strong>Шифрование:</strong> AES-256-CBC (TDE)</p>
                        <p><strong>Backup:</strong> Автоматический</p>
                        <p><strong>API:</strong> <a href="/api" target="_blank">Документация</a></p>
                    </div>

                    <div class="btn-group" style="margin-top: 1rem;">
                        <button class="btn btn-outline btn-sm" onclick="checkSystemHealth()">
                            🔄 Проверить статус
                        </button>
                        <button class="btn btn-outline btn-sm" onclick="loadDashboardData()">
                            📊 Обновить данные
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Patients Section -->
        <section id="patients" class="content-section">
            <div class="grid grid-2">
                <!-- Add Patient Form -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">➕ Добавить пациента</h3>
                    </div>
                    
                    <form id="patient-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Фамилия *</label>
                                <input type="text" name="last_name" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Имя *</label>
                                <input type="text" name="first_name" class="form-control" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Отчество</label>
                                <input type="text" name="middle_name" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Дата рождения *</label>
                                <input type="date" name="birth_date" class="form-control" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Пол *</label>
                                <select name="gender" class="form-control" required>
                                    <option value="">Выберите пол</option>
                                    <option value="M">Мужской</option>
                                    <option value="F">Женский</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Телефон</label>
                                <input type="tel" name="phone" class="form-control" placeholder="+7 (999) 123-45-67">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-control">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Адрес</label>
                            <textarea name="address" class="form-control" rows="2" 
                                      placeholder="Город, улица, дом, квартира"></textarea>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn btn-success">
                                ✅ Добавить пациента
                            </button>
                            <button type="reset" class="btn btn-outline">
                                🗑️ Очистить форму
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Search Patients -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">🔍 Поиск пациентов</h3>
                    </div>
                    
                    <form id="patient-search-form">
                        <div class="form-group">
                            <label class="form-label">Поиск по ФИО или контактам</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="patient-search-input"
                                   placeholder="Фамилия, имя, телефон или email..."
                                   minlength="2">
                        </div>
                        
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">
                                🔍 Найти
                            </button>
                            <button type="button" class="btn btn-outline" onclick="loadPatients()">
                                📋 Показать всех
                            </button>
                            <button type="button" class="btn btn-outline" onclick="clearPatientSearch()">
                                ✖️ Очистить
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Patients List -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">👥 Список пациентов</h3>
                    <div class="btn-group">
                        <button class="btn btn-outline btn-sm" onclick="loadPatients(1, 20)">
                            20 на стр.
                        </button>
                        <button class="btn btn-outline btn-sm" onclick="loadPatients(1, 50)">
                            50 на стр.
                        </button>
                    </div>
                </div>
                
                <div id="patients-list-container">
                    <div class="loading">Загрузка списка пациентов...</div>
                </div>
            </div>
        </section>

        <!-- Appointments Section -->
        <section id="appointments" class="content-section">
            <div class="grid grid-2">
                <!-- Create Appointment Form -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">➕ Записать на приём</h3>
                    </div>
                    
                    <form id="appointment-form">
                        <div class="form-group">
                            <label class="form-label">Пациент *</label>
                            <select name="patient_id" class="form-control" required>
                                <option value="">Выберите пациента</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Врач *</label>
                            <select name="doctor_id" class="form-control" required>
                                <option value="">Выберите врача</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Дата приёма *</label>
                                <input type="date" name="appointment_date" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Время *</label>
                                <input type="time" name="appointment_time" class="form-control" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Статус</label>
                            <select name="status" class="form-control">
                                <option value="scheduled">Запланирован</option>
                                <option value="completed">Завершён</option>
                                <option value="cancelled">Отменён</option>
                            </select>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn btn-success">
                                ✅ Записать на приём
                            </button>
                            <button type="reset" class="btn btn-outline">
                                🗑️ Очистить форму
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Filter Appointments -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">🔍 Фильтр приёмов</h3>
                    </div>
                    
                    <form id="appointment-filter-form">
                        <div class="form-group">
                            <label class="form-label">Статус приёма</label>
                            <select class="form-control" id="appointment-status-filter">
                                <option value="">Все приёмы</option>
                                <option value="scheduled">Запланированные</option>
                                <option value="completed">Завершённые</option>
                                <option value="cancelled">Отменённые</option>
                            </select>
                        </div>
                        
                        <div class="btn-group">
                            <button type="button" class="btn btn-primary" onclick="filterAppointments()">
                                🔍 Применить фильтр
                            </button>
                            <button type="button" class="btn btn-outline" onclick="loadAppointments()">
                                📋 Показать все
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Appointments List -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">📅 Список приёмов</h3>
                    <div class="btn-group">
                        <button class="btn btn-outline btn-sm" onclick="loadAppointments(1, 20)">
                            20 на стр.
                        </button>
                        <button class="btn btn-outline btn-sm" onclick="loadAppointments(1, 50)">
                            50 на стр.
                        </button>
                    </div>
                </div>
                
                <div id="appointments-list-container">
                    <div class="loading">Загрузка приёмов...</div>
                </div>
            </div>
        </section>

        <!-- Medical Records Section -->
        <section id="records" class="content-section">
            <div class="grid grid-2">
                <!-- Create Medical Record Form -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">➕ Создать медкарту</h3>
                    </div>
                    
                    <form id="medical-record-form">
                        <div class="form-group">
                            <label class="form-label">Завершённый приём *</label>
                            <select name="appointment_id" class="form-control" required>
                                <option value="">Выберите приём</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Жалобы пациента</label>
                            <textarea name="complaints" class="form-control" rows="3" 
                                      placeholder="Основные жалобы пациента..."></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Результаты осмотра</label>
                            <textarea name="examination_results" class="form-control" rows="3" 
                                      placeholder="Данные осмотра, показатели..."></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Диагноз * (будет зашифрован)</label>
                            <textarea name="diagnosis" class="form-control" rows="2" required
                                      placeholder="Диагноз врача..."></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Назначения</label>
                            <div id="prescriptions-container">
                                <div class="prescription-item" style="border: 1px solid var(--border-color); padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <input type="text" name="medication_name_1" class="form-control" placeholder="Название препарата">
                                        </div>
                                        <div class="form-group">
                                            <input type="text" name="dosage_1" class="form-control" placeholder="Дозировка">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <input type="text" name="frequency_1" class="form-control" placeholder="Частота приёма">
                                        </div>
                                        <div class="form-group">
                                            <input type="text" name="duration_1" class="form-control" placeholder="Длительность">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <input type="text" name="notes_1" class="form-control" placeholder="Примечания">
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline btn-sm" onclick="addPrescription()">
                                ➕ Добавить назначение
                            </button>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn btn-success">
                                ✅ Создать медкарту
                            </button>
                            <button type="reset" class="btn btn-outline">
                                🗑️ Очистить форму
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Medical Records Search -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">🔍 Поиск медкарт</h3>
                    </div>
                    
                    <form id="records-search-form">
                        <div class="form-group">
                            <label class="form-label">Поиск по пациенту</label>
                            <input type="text" class="form-control" id="records-search-input"
                                   placeholder="ФИО пациента...">
                        </div>
                        
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">
                                🔍 Найти
                            </button>
                            <button type="button" class="btn btn-outline" onclick="loadMedicalRecords()">
                                📋 Показать все
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Medical Records List -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">📋 Медицинские записи</h3>
                    <div class="btn-group">
                        <button class="btn btn-outline btn-sm" onclick="loadMedicalRecords(1, 20)">
                            20 на стр.
                        </button>
                        <button class="btn btn-outline btn-sm" onclick="loadMedicalRecords(1, 50)">
                            50 на стр.
                        </button>
                    </div>
                </div>
                
                <div id="medical-records-list-container">
                    <div class="loading">Загрузка медкарт...</div>
                </div>
            </div>
        </section>

        <section id="doctors" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">👨‍⚕️ Врачи</h3>
                </div>
                <div id="doctors-list-container">
                    <div class="loading">Загрузка списка врачей...</div>
                </div>
            </div>
        </section>

        <section id="statistics" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">📈 Статистика</h3>
                </div>
                <div id="statistics-container">
                    <div class="loading">Загрузка статистики...</div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Global Configuration
        const API_BASE_URL = window.location.origin;
        
        // Global State
        let currentSection = 'dashboard';
        let currentPage = { patients: 1, appointments: 1, records: 1 };

        // Utility Functions
        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ru-RU');
            } catch (e) {
                return dateString;
            }
        }

        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return '-';
            try {
                const date = new Date(dateTimeString);
                return date.toLocaleString('ru-RU');
            } catch (e) {
                return dateTimeString;
            }
        }

        function formatPhone(phone) {
            return phone || 'не указан';
        }

        function formatEmail(email) {
            return email || 'не указан';
        }

        // Alert System
        function showAlert(message, type = 'success') {
            const alertEl = document.getElementById('alert-message');
            alertEl.className = `alert ${type}`;
            alertEl.textContent = message;
            alertEl.style.display = 'flex';
            
            setTimeout(() => {
                alertEl.style.display = 'none';
            }, 5000);
        }

        // API Client with better error handling
        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                },
            };

            try {
                console.log('API Request:', url, options); // Для отладки
                
                const response = await fetch(url, { ...defaultOptions, ...options });
                
                if (!response.ok) {
                    let errorMessage;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorData.message || `HTTP ${response.status}`;
                        console.log('Ошибка API (JSON):', errorData); // Для отладки
                    } catch (e) {
                        const errorText = await response.text();
                        errorMessage = errorText || `HTTP ${response.status}: ${response.statusText}`;
                        console.log('Ошибка API (Text):', errorText); // Для отладки
                    }
                    throw new Error(errorMessage);
                }

                const responseData = await response.json();
                console.log('API Response:', responseData); // Для отладки
                return responseData;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Navigation
        function showSection(sectionId) {
            // Update tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[onclick="showSection('${sectionId}')"]`).classList.add('active');

            // Update sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            currentSection = sectionId;

            // Load section data
            loadSectionData(sectionId);
        }

        function loadSectionData(sectionId) {
            switch (sectionId) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'patients':
                    loadPatients();
                    break;
                case 'doctors':
                    loadDoctors();
                    break;
                case 'statistics':
                    loadStatistics();
                    break;
            }
        }

        // Dashboard
        async function loadDashboard() {
            try {
                const stats = await apiRequest('/api/statistics');
                
                // Update dashboard stats
                document.getElementById('stat-patients').textContent = stats.general?.total_patients || 0;
                document.getElementById('stat-doctors').textContent = stats.general?.total_doctors || 0;
                document.getElementById('stat-appointments').textContent = stats.general?.total_appointments || 0;
                document.getElementById('stat-scheduled').textContent = stats.general?.scheduled_appointments || 0;
                
            } catch (error) {
                console.error('Dashboard load error:', error);
                showAlert('Ошибка загрузки статистики: ' + error.message, 'error');
            }
        }

        // Patients
        async function loadPatients(page = 1, perPage = 20) {
            const container = document.getElementById('patients-list-container');
            container.innerHTML = '<div class="loading">Загрузка пациентов...</div>';

            try {
                const response = await apiRequest(`/api/patients?page=${page}&per_page=${perPage}`);
                renderPatientsList(response, container);
                currentPage.patients = page;
            } catch (error) {
                container.innerHTML = `<div class="alert error">Ошибка загрузки: ${error.message}</div>`;
            }
        }

        function renderPatientsList(response, container) {
            if (!response.patients || response.patients.length === 0) {
                container.innerHTML = '<div class="empty-state">Пациенты не найдены</div>';
                return;
            }

            let html = `
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ФИО</th>
                                <th>Дата рождения</th>
                                <th>Пол</th>
                                <th>Телефон</th>
                                <th>Email</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            response.patients.forEach(patient => {
                const fullName = `${patient.last_name} ${patient.first_name} ${patient.middle_name || ''}`.trim();
                const gender = patient.gender === 'M' ? '👨 М' : '👩 Ж';
                
                html += `
                    <tr class="clickable" onclick="viewPatientDetails(${patient.id})">
                        <td>${patient.id}</td>
                        <td><strong>${fullName}</strong></td>
                        <td>${formatDate(patient.birth_date)}</td>
                        <td>${gender}</td>
                        <td>${formatPhone(patient.phone)}</td>
                        <td>${formatEmail(patient.email)}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            // Add pagination if needed
            if (response.pagination && response.pagination.pages > 1) {
                html += renderPagination(response.pagination, 'loadPatients');
            }

            container.innerHTML = html;
        }

        function renderPagination(pagination, functionName) {
            const { page, pages } = pagination;
            
            let html = '<div class="pagination">';
            
            // Previous button
            html += `<button class="btn btn-outline ${page <= 1 ? '' : 'btn-primary'}" 
                     ${page <= 1 ? 'disabled' : ''} 
                     onclick="${functionName}(${page - 1})">‹</button>`;
            
            // Page numbers
            const startPage = Math.max(1, page - 2);
            const endPage = Math.min(pages, page + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="btn ${i === page ? 'btn-primary active' : 'btn-outline'}" 
                         onclick="${functionName}(${i})">${i}</button>`;
            }
            
            // Next button
            html += `<button class="btn btn-outline ${page >= pages ? '' : 'btn-primary'}" 
                     ${page >= pages ? 'disabled' : ''} 
                     onclick="${functionName}(${page + 1})">›</button>`;
            
            html += '</div>';
            html += `<div class="pagination-info">Страница ${page} из ${pages}</div>`;
            
            return html;
        }

        // Search patients
        async function searchPatients(event) {
            event.preventDefault();
            const query = document.getElementById('patient-search-input').value.trim();
            
            if (query.length < 2) {
                showAlert('Введите минимум 2 символа для поиска', 'warning');
                return;
            }

            const container = document.getElementById('patients-list-container');
            container.innerHTML = '<div class="loading">Поиск пациентов...</div>';

            try {
                const response = await apiRequest(`/api/search?q=${encodeURIComponent(query)}`);
                
                if (response.patients && response.patients.length > 0) {
                    renderSearchResults(response.patients, container);
                } else {
                    container.innerHTML = '<div class="empty-state">По запросу ничего не найдено</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="alert error">Ошибка поиска: ${error.message}</div>`;
            }
        }

        function renderSearchResults(patients, container) {
            let html = `
                <div style="padding: 1rem; background: #e3f2fd; border-radius: 8px; margin-bottom: 1rem;">
                    🔍 Результаты поиска: найдено ${patients.length} пациентов
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ФИО</th>
                                <th>Дата рождения</th>
                                <th>Телефон</th>
                                <th>Email</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            patients.forEach(patient => {
                const fullName = `${patient.last_name} ${patient.first_name} ${patient.middle_name || ''}`.trim();
                html += `
                    <tr class="clickable" onclick="viewPatientDetails(${patient.id})">
                        <td>${patient.id}</td>
                        <td><strong>${fullName}</strong></td>
                        <td>${formatDate(patient.birth_date)}</td>
                        <td>${formatPhone(patient.phone)}</td>
                        <td>${formatEmail(patient.email)}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        // Patient details
        async function viewPatientDetails(patientId) {
            try {
                const patient = await apiRequest(`/api/patients/${patientId}`);
                
                const details = `
Пациент: ${patient.last_name} ${patient.first_name} ${patient.middle_name || ''}
Дата рождения: ${formatDate(patient.birth_date)}
Пол: ${patient.gender === 'M' ? 'Мужской' : 'Женский'}
Телефон: ${formatPhone(patient.phone)}
Email: ${formatEmail(patient.email)}
Адрес: ${patient.address || 'не указан'}

Всего приёмов: ${patient.total_appointments || 0}
Последний приём: ${formatDateTime(patient.last_appointment)}
                `.trim();

                alert(details);
            } catch (error) {
                showAlert('Ошибка загрузки данных пациента: ' + error.message, 'error');
            }
        }

        // Create patient
        async function createPatient(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);

            // Validate required fields
            const requiredFields = ['first_name', 'last_name', 'birth_date', 'gender'];
            for (let field of requiredFields) {
                if (!data[field] || data[field].trim() === '') {
                    showAlert(`Поле "${field}" обязательно для заполнения`, 'error');
                    return;
                }
            }

            // Clean and validate phone
            if (data.phone) {
                let phone = data.phone.replace(/\D/g, ''); // Remove all non-digits
                if (phone.length === 11 && phone.startsWith('7')) {
                    data.phone = `+${phone}`;
                } else if (phone.length === 11 && phone.startsWith('8')) {
                    data.phone = `+7${phone.slice(1)}`;
                } else if (phone.length === 10) {
                    data.phone = `+7${phone}`;
                } else if (phone.length < 10 || phone.length > 11) {
                    showAlert('Неверный формат телефона. Введите российский номер', 'error');
                    return;
                }
            } else {
                // Remove empty phone field
                delete data.phone;
            }

            // Clean empty fields
            Object.keys(data).forEach(key => {
                if (data[key] === '' || data[key] === null) {
                    delete data[key];
                }
            });

            console.log('Отправляемые данные:', data); // Для отладки

            try {
                const response = await apiRequest('/api/patients', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                showAlert('Пациент успешно добавлен');
                event.target.reset();
                
                if (currentSection === 'patients') {
                    loadPatients();
                }
            } catch (error) {
                console.error('Полная ошибка:', error); // Для отладки
                showAlert('Ошибка добавления пациента: ' + error.message, 'error');
            }
        }

        // Quick search
        async function quickSearch(event) {
            event.preventDefault();
            const query = document.getElementById('quick-search-input').value.trim();
            
            if (query.length < 2) {
                showAlert('Введите минимум 2 символа для поиска', 'warning');
                return;
            }

            const resultsContainer = document.getElementById('quick-search-results');
            resultsContainer.innerHTML = '<div class="loading">Поиск...</div>';

            try {
                const response = await apiRequest(`/api/search?q=${encodeURIComponent(query)}`);
                renderQuickSearchResults(response.patients || [], resultsContainer);
            } catch (error) {
                resultsContainer.innerHTML = `<div class="alert error">Ошибка поиска: ${error.message}</div>`;
            }
        }

        function renderQuickSearchResults(patients, container) {
            if (patients.length === 0) {
                container.innerHTML = '<div class="empty-state">Пациенты не найдены</div>';
                return;
            }

            let html = `<h4 style="margin: 1rem 0 0.5rem 0; color: var(--primary-color);">Результаты поиска (${patients.length})</h4>`;
            
            patients.forEach(patient => {
                const fullName = `${patient.last_name} ${patient.first_name} ${patient.middle_name || ''}`.trim();
                html += `
                    <div onclick="viewPatientDetails(${patient.id})" style="cursor: pointer; padding: 12px; margin: 8px 0; background: #f8f9fa; border-radius: 6px; border-left: 4px solid var(--secondary-color);">
                        <strong>${fullName}</strong><br>
                        <small>
                            Дата рождения: ${formatDate(patient.birth_date)} | 
                            Телефон: ${formatPhone(patient.phone)} | 
                            Email: ${formatEmail(patient.email)}
                        </small>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Load doctors
        async function loadDoctors() {
            const container = document.getElementById('doctors-list-container');
            container.innerHTML = '<div class="loading">Загрузка врачей...</div>';

            try {
                const response = await apiRequest('/api/search?type=doctors');
                renderDoctorsList(response.doctors || [], container);
            } catch (error) {
                container.innerHTML = `<div class="alert error">Ошибка загрузки: ${error.message}</div>`;
            }
        }

        function renderDoctorsList(doctors, container) {
            if (doctors.length === 0) {
                container.innerHTML = '<div class="empty-state">Врачи не найдены</div>';
                return;
            }

            let html = `
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ФИО</th>
                                <th>Специализация</th>
                                <th>Телефон</th>
                                <th>Email</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            doctors.forEach(doctor => {
                const fullName = `${doctor.last_name} ${doctor.first_name} ${doctor.middle_name || ''}`.trim();
                html += `
                    <tr>
                        <td>${doctor.id}</td>
                        <td><strong>${fullName}</strong></td>
                        <td><span class="badge badge-success">${doctor.specialization}</span></td>
                        <td>${formatPhone(doctor.phone)}</td>
                        <td>${formatEmail(doctor.email)}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        // Load statistics
        async function loadStatistics() {
            const container = document.getElementById('statistics-container');
            container.innerHTML = '<div class="loading">Загрузка статистики...</div>';

            try {
                const stats = await apiRequest('/api/statistics');
                renderStatistics(stats, container);
            } catch (error) {
                container.innerHTML = `<div class="alert error">Ошибка загрузки статистики: ${error.message}</div>`;
            }
        }

        function renderStatistics(stats, container) {
            if (!stats.general) {
                container.innerHTML = '<div class="empty-state">Статистика недоступна</div>';
                return;
            }

            let html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${stats.general.total_patients || 0}</div>
                        <div class="stat-label">Всего пациентов</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-number">${stats.general.total_doctors || 0}</div>
                        <div class="stat-label">Всего врачей</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-number">${stats.general.total_appointments || 0}</div>
                        <div class="stat-label">Всего приёмов</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-number">${stats.general.scheduled_appointments || 0}</div>
                        <div class="stat-label">Запланировано</div>
                    </div>
                </div>
            `;

            if (stats.doctors && stats.doctors.length > 0) {
                html += `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">📊 Статистика по врачам</h3>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Врач</th>
                                        <th>Специализация</th>
                                        <th>Количество приёмов</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                stats.doctors.forEach(doctor => {
                    html += `
                        <tr>
                            <td><strong>${doctor.last_name} ${doctor.first_name}</strong></td>
                            <td>${doctor.specialization}</td>
                            <td><span class="badge badge-success">${doctor.appointment_count}</span></td>
                        </tr>
                    `;
                });

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // System health check
        async function checkSystemHealth() {
            showAlert('Проверка статуса системы...', 'warning');
            
            try {
                const health = await apiRequest('/health');
                
                // Update indicators
                const dbStatus = document.getElementById('db-status');
                const apiStatus = document.getElementById('api-status');
                const tdeStatus = document.getElementById('tde-status');
                
                dbStatus.className = `status-indicator ${health.database === 'OK' ? '' : 'error'}`;
                apiStatus.className = `status-indicator ${health.status === 'OK' ? '' : 'error'}`;
                tdeStatus.className = `status-indicator ${health.details && !health.details.error ? '' : 'error'}`;
                
                const healthyCount = [
                    health.database === 'OK',
                    health.status === 'OK',
                    health.details && !health.details.error
                ].filter(Boolean).length;
                
                showAlert(`Проверка завершена: ${healthyCount}/3 компонентов работают нормально`);
                
            } catch (error) {
                showAlert('Ошибка проверки статуса: ' + error.message, 'error');
                
                // Mark all as error
                document.querySelectorAll('.status-indicator').forEach(indicator => {
                    indicator.classList.add('error');
                });
            }
        }

        // Helper functions
        function clearQuickSearch() {
            document.getElementById('quick-search-input').value = '';
            document.getElementById('quick-search-results').innerHTML = '';
        }

        function clearPatientSearch() {
            document.getElementById('patient-search-input').value = '';
            loadPatients();
        }

        function loadDashboardData() {
            loadDashboard();
            showAlert('Данные обновлены');
        }

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🏥 Инициализация системы медкарт...');
            
            // Setup forms
            document.getElementById('quick-search-form').addEventListener('submit', quickSearch);
            document.getElementById('patient-form').addEventListener('submit', createPatient);
            document.getElementById('patient-search-form').addEventListener('submit', searchPatients);

            // Setup date inputs
            const today = new Date().toISOString().split('T')[0];
            const birthDateInput = document.querySelector('input[name="birth_date"]');
            if (birthDateInput) {
                birthDateInput.max = today;
            }

            // Enhanced auto-format phone inputs
            document.querySelectorAll('input[type="tel"]').forEach(input => {
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    
                    // Don't format if empty
                    if (value === '') {
                        e.target.value = '';
                        return;
                    }
                    
                    // Convert 8 to 7
                    if (value.startsWith('8') && value.length === 11) {
                        value = '7' + value.slice(1);
                    }
                    
                    // Format based on length
                    if (value.length <= 1) {
                        e.target.value = value.startsWith('7') ? '+7' : value;
                    } else if (value.length <= 4) {
                        e.target.value = `+7 (${value.slice(1)}`;
                    } else if (value.length <= 7) {
                        e.target.value = `+7 (${value.slice(1,4)}) ${value.slice(4)}`;
                    } else if (value.length <= 9) {
                        e.target.value = `+7 (${value.slice(1,4)}) ${value.slice(4,7)}-${value.slice(7)}`;
                    } else if (value.length <= 11) {
                        e.target.value = `+7 (${value.slice(1,4)}) ${value.slice(4,7)}-${value.slice(7,9)}-${value.slice(9,11)}`;
                    }
                });

                // Add placeholder and pattern
                input.placeholder = '+7 (999) 123-45-67';
                input.pattern = '\\+7\\s\\([0-9]{3}\\)\\s[0-9]{3}-[0-9]{2}-[0-9]{2}';
            });

            // Add form validation helper
            function validateForm(form) {
                let isValid = true;
                const inputs = form.querySelectorAll('[required]');
                
                inputs.forEach(input => {
                    if (!input.value.trim()) {
                        input.style.borderColor = 'var(--danger-color)';
                        isValid = false;
                    } else {
                        input.style.borderColor = '';
                    }
                });
                
                return isValid;
            }

            // Add real-time validation to required fields
            document.querySelectorAll('[required]').forEach(input => {
                input.addEventListener('blur', function() {
                    if (!this.value.trim()) {
                        this.style.borderColor = 'var(--danger-color)';
                    } else {
                        this.style.borderColor = '';
                    }
                });
                
                input.addEventListener('input', function() {
                    if (this.value.trim()) {
                        this.style.borderColor = '';
                    }
                });
            });

            // Initial load
            checkSystemHealth();
            loadDashboard();
            
            console.log('✅ Система инициализирована');
        });

        // Error handling
        window.addEventListener('error', function(e) {
            console.error('Глобальная ошибка:', e.error);
            showAlert('Произошла неожиданная ошибка. Проверьте консоль для деталей.', 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Необработанная ошибка Promise:', e.reason);
            if (e.reason && e.reason.message) {
                showAlert('Ошибка API: ' + e.reason.message, 'error');
            }
        });

        console.log('🏥 Система электронных медкарт готова к работе!');
    </script>
</body>
</html>